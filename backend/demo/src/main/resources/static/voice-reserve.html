<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŒì„±ì¸ì‹ ê¸°ì°¨ ì˜ˆë§¤</title>
    <style>
        body { 
            font-family: 'Noto Sans KR', sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
            background-color: #f9f9f9;
        }
        h1 {
            text-align: center;
            color: #003b4f;
        }
        .instructions {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        #startButton { 
            font-size: 1.2em; 
            padding: 15px 30px; 
            background-color: #00b4ff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: block;
            margin: 20px auto;
            font-weight: bold;
        }
        #startButton:hover {
            background-color: #0095d9;
        }
        #startButton:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #status { 
            margin-top: 15px; 
            font-weight: bold; 
            text-align: center;
            color: #0058d4;
        }
        #transcript { 
            margin-top: 10px; 
            padding: 15px; 
            border: 2px solid #ddd; 
            min-height: 60px;
            background-color: white;
            border-radius: 8px;
            font-size: 16px;
        }
        #results { 
            margin-top: 20px; 
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 15px;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        th, td { 
            border: 1px solid #ddd; 
            padding: 12px; 
            text-align: left; 
        }
        .reserve-btn {
            background-color: #00b4ff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .reserve-btn:hover {
            background-color: #0095d9;
        }
        th { 
            background-color: #003b4f; 
            color: white;
            font-weight: bold;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .back-btn {
            display: inline-block;
            margin-bottom: 20px;
            padding: 10px 20px;
            background-color: #666;
            color: white;
            text-decoration: none;
            border-radius: 5px;
        }
        .back-btn:hover {
            background-color: #555;
        }
        .error {
            color: #d32f2f;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <a href="/train-reserve" class="back-btn">â† ëŒì•„ê°€ê¸°</a>

    <h1>ìŒì„±ì¸ì‹ ê¸°ì°¨ ì˜ˆë§¤</h1>
    
    <div class="instructions">
        <p><strong>ì‚¬ìš© ë°©ë²•:</strong></p>
        <p>ğŸ¤ "ì„œìš¸ì—ì„œ ë¶€ì‚° ê°€ëŠ” ê¸°ì°¨ ì°¾ì•„ì¤˜" ë˜ëŠ” "8ì›” 10ì¼ ê´‘ì£¼ì†¡ì •ë¶€í„° ìš©ì‚°ê¹Œì§€ ê°€ëŠ” ê¸°ì°¨" í˜•ì‹ìœ¼ë¡œ ë§ì”€í•´ë³´ì„¸ìš”.</p>
    </div>

    <button id="startButton">ğŸ¤ ìŒì„±ì¸ì‹ ì‹œì‘</button>
    <div id="status">ë²„íŠ¼ì„ ëˆ„ë¥´ê³  ë§ì”€í•˜ì„¸ìš”.</div>
    
    <h3>ì¸ì‹ëœ í…ìŠ¤íŠ¸:</h3>
    <div id="transcript">...</div>

    <hr style="margin: 30px 0;">

    <h3>ì¡°íšŒ ê²°ê³¼:</h3>
    <div id="results">ì¡°íšŒëœ ê¸°ì°¨ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>

    <script>
        const startButton = document.getElementById('startButton');
        const statusDiv = document.getElementById('status');
        const transcriptDiv = document.getElementById('transcript');
        const resultsDiv = document.getElementById('results');

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        
        if (!SpeechRecognition) {
            statusDiv.innerHTML = '<span class="error">ì£„ì†¡í•˜ì§€ë§Œ, ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</span>';
            startButton.disabled = true;
        } else {
            const recognition = new SpeechRecognition();
            recognition.lang = 'ko-KR';
            recognition.continuous = false;
            recognition.interimResults = false;

            startButton.addEventListener('click', () => {
                recognition.start();
            });

            recognition.onstart = () => {
                statusDiv.innerHTML = 'ğŸ¤ ìŒì„± ì¸ì‹ ì¤‘... ë§ì”€í•´ì£¼ì„¸ìš”!';
                statusDiv.style.color = '#d32f2f';
                startButton.disabled = true;
            };

            recognition.onend = () => {
                statusDiv.innerHTML = 'ìŒì„± ì¸ì‹ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•˜ë ¤ë©´ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.';
                statusDiv.style.color = '#0058d4';
                startButton.disabled = false;
            };

            recognition.onerror = (event) => {
                statusDiv.innerHTML = '<span class="error">ìŒì„± ì¸ì‹ ì˜¤ë¥˜: ' + event.error + '</span>';
                startButton.disabled = false;
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                transcriptDiv.textContent = transcript;
                parseCommand(transcript);
            };
        }

        function parseCommand(command) {
            console.log('ì›ë³¸ ëª…ë ¹:', command);
            
            // ì—­ ì´ë¦„ ì •ê·œí™” ë§µ
            const stationMap = {
                'ê´‘ì£¼': 'ê´‘ì£¼ì†¡ì •',
                'ê´‘ì£¼ì—­': 'ê´‘ì£¼ì†¡ì •',
                'ìš©ì‚°ì—­': 'ìš©ì‚°',
                'ì„œìš¸': 'ìš©ì‚°',
                'ì„œìš¸ì—­': 'ìš©ì‚°'
            };
            
            // ë‚ ì§œ ì¶”ì¶œ (ì„ íƒ)
            const datePattern = /(\d+)\s*ì›”\s*(\d+)\s*ì¼/;
            const dateMatch = command.match(datePattern);
            
            // ë‚ ì§œ ë¶€ë¶„ ì œê±°í•œ í…ìŠ¤íŠ¸
            let textWithoutDate = command;
            if (dateMatch) {
                textWithoutDate = command.replace(dateMatch[0], '').trim();
            }
            
            // ì¶œë°œì§€-ë„ì°©ì§€ íŒ¨í„´ (ë” ìœ ì—°í•˜ê²Œ)
            const routePatterns = [
                /(\S+?)\s*(?:ì—ì„œ|ë¶€í„°|ì—­ì—ì„œ)\s*(\S+?)\s*(?:ê¹Œì§€|ê°€ëŠ”|ê°€|í–‰|ìœ¼ë¡œ|ì—­)/,
                /(\S+?)\s+(\S+?)\s*(?:ê°€ëŠ”|í–‰)/
            ];
            
            let origin, destination;
            for (const pattern of routePatterns) {
                const match = textWithoutDate.match(pattern);
                if (match) {
                    origin = match[1].replace(/ì—­$/, '').trim();
                    destination = match[2].replace(/ì—­$/, '').trim();
                    break;
                }
            }
            
            if (origin && destination) {
                // ì—­ ì´ë¦„ ì •ê·œí™”
                origin = stationMap[origin] || origin;
                destination = stationMap[destination] || destination;
                
                const month = dateMatch ? dateMatch[1] : null;
                const day = dateMatch ? dateMatch[2] : null;

                let searchDate;
                if (month && day) {
                    // ìŒì„±ìœ¼ë¡œ ë‚ ì§œë¥¼ ë§í•œ ê²½ìš° (ì˜¬í•´ ë…„ë„ ì‚¬ìš©)
                    const year = new Date().getFullYear();
                    searchDate = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                } else {
                    // ë‚ ì§œë¥¼ ë§í•˜ì§€ ì•Šì€ ê²½ìš° (ì˜¤ëŠ˜ ë‚ ì§œ ì‚¬ìš©)
                    searchDate = new Date().toISOString().split('T')[0];
                }
                
                console.log('íŒŒì‹± ê²°ê³¼:', { origin, destination, searchDate });
                statusDiv.innerHTML = `'${searchDate}' ë‚ ì§œì— '${origin}'ì—ì„œ '${destination}'(ìœ¼)ë¡œ ê°€ëŠ” ê¸°ì°¨ë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤.`;
                searchTrains(origin, destination, searchDate);
            } else {
                console.log('íŒŒì‹± ì‹¤íŒ¨');
                statusDiv.innerHTML = '<span class="error">ëª…ë ¹ì„ ì´í•´í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. "[ë‚ ì§œ] ì¶œë°œì§€ì—ì„œ ë„ì°©ì§€ ê°€ëŠ”" í˜•ì‹ìœ¼ë¡œ ë§ì”€í•´ì£¼ì„¸ìš”.</span>';
            }
        }

        function searchTrains(origin, destination, date) {
            const url = `/api/trains?origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(destination)}&date=${date}`;
            
            resultsDiv.innerHTML = '<p style="text-align: center;">ğŸ” ê²€ìƒ‰ ì¤‘...</p>';

            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status} ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(trains => {
                    displayTrains(trains);
                })
                .catch(error => {
                    console.error('Error fetching trains:', error);
                    resultsDiv.innerHTML = `<p class="error">ê¸°ì°¨ ì •ë³´ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</p>`;
                });
        }

        function displayTrains(trains) {
            if (!trains || trains.length === 0) {
                resultsDiv.innerHTML = '<p>í•´ë‹¹ ì¡°ê±´ì˜ ê¸°ì°¨ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            const table = document.createElement('table');
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>ê¸°ì°¨ ë²ˆí˜¸</th>
                        <th>ì¶œë°œì§€</th>
                        <th>ë„ì°©ì§€</th>
                        <th>ì¶œë°œ ì‹œê°„</th>
                        <th>ë„ì°© ì‹œê°„</th>
                        <th>ê°€ê²©</th>
                        <th>ì˜ˆë§¤</th>
                    </tr>
                </thead>
                <tbody>
                    ${trains.map(train => `
                        <tr>
                            <td>${train.trainNumber}</td>
                            <td>${train.origin}</td>
                            <td>${train.destination}</td>
                            <td>${formatDateTime(train.departureTime)}</td>
                            <td>${formatDateTime(train.arrivalTime)}</td>
                            <td>${train.price.toLocaleString()}ì›</td>
                            <td><button class="reserve-btn" onclick="reserveTrain(${train.id}, '${train.trainNumber}')">ì˜ˆë§¤í•˜ê¸°</button></td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            resultsDiv.innerHTML = '';
            resultsDiv.appendChild(table);
        }

        function formatDateTime(dateTimeString) {
            const date = new Date(dateTimeString);
            return date.toLocaleString('ko-KR', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function reserveTrain(trainId, trainNumber) {
            // JWT í† í° í™•ì¸
            const token = localStorage.getItem('token');
            if (!token) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '/login.html';
                return;
            }

            if (!confirm(`${trainNumber} ê¸°ì°¨ë¥¼ ì˜ˆë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            // ì˜ˆë§¤ API í˜¸ì¶œ
            fetch('/api/bookings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    trainId: trainId
                })
            })
            .then(response => {
                if (response.status === 401) {
                    alert('ë¡œê·¸ì¸ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                    localStorage.removeItem('token');
                    window.location.href = '/login.html';
                    return;
                }
                if (!response.ok) {
                    throw new Error('ì˜ˆë§¤ ì‹¤íŒ¨');
                }
                return response.json();
            })
            .then(booking => {
                if (booking) {
                    alert(`ì˜ˆë§¤ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\nì˜ˆë§¤ë²ˆí˜¸: ${booking.id}`);
                    // ë§ˆì´í˜ì´ì§€ë¡œ ì´ë™í• ì§€ ë¬¼ì–´ë³´ê¸°
                    if (confirm('ì˜ˆë§¤ ë‚´ì—­ì„ í™•ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        window.location.href = '/mypage.html';
                    }
                }
            })
            .catch(error => {
                console.error('ì˜ˆë§¤ ì˜¤ë¥˜:', error);
                alert('ì˜ˆë§¤ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            });
        }
    </script>

</body>
</html>
